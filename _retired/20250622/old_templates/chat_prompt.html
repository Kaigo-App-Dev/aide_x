{% extends "base.html" %}
{% block content %}

<h2>ğŸ§  æ§‹æˆå…±å‰µãƒãƒ£ãƒƒãƒˆï¼ˆChatGPTï¼‰</h2>

<!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º -->
<div class="chat-box">
  {% for message in chat_history %}
    <div class="chat-message {{ message.role }}">
      {% if message.role == "user" %}
        <strong>ğŸ‘¤ ã‚ãªãŸï¼š</strong>
      {% elif message.role == "assistant" %}
        <strong>ğŸ¤– AIDE-Xï¼š</strong>
      {% elif message.role == "analyzer" %}
        <strong>ğŸ’¬ AIDE-Xï¼ˆåˆ†æï¼‰ï¼š</strong>
      {% endif %}
      <span class="chat-bubble {{ message.role }}">{{ message.content }}</span>
    </div>
  {% endfor %}
</div>

<!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="text" name="message" placeholder="è³ªå•ã‚„è¦æœ›ã‚’å…¥åŠ›..." class="form-control" required>
  <button type="submit" class="btn btn-primary mt-2">é€ä¿¡</button>
</form>

<!-- âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãŒ "suggest" ã®ã¨ãã«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º -->
{% if stage == "suggest" %}
<hr>
<h4>ğŸ’¡ ãã‚ãã‚æ§‹æˆã‚’å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ</h4>
<div class="btn-group" role="group">
  <form method="post" style="display:inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" name="message" value="æ§‹æˆã‚’è¦‹ã›ã¦" class="btn btn-success">â–¶ æ§‹æˆã‚’è¦‹ã¦ã¿ã‚‹</button>
  </form>
  <form method="post" style="display:inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" name="message" value="ã¾ã è©±ã™" class="btn btn-secondary">â–¶ è©±ã‚’ç¶šã‘ã‚‹</button>
  </form>
  <form method="post" style="display:inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" name="message" value="æ¡ä»¶ã ã‘ã¾ã¨ã‚ã¦" class="btn btn-info">â–¶ æ¡ä»¶ã ã‘ã¾ã¨ã‚ã‚‹</button>
  </form>
</div>
{% endif %}

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="mt-3">
  <a href="{{ url_for('chat.chat_prompt') }}?confirm=1" class="btn btn-success">âœ… ã“ã®æ§‹æˆã§é€²ã‚ã‚‹</a>
  <a href="{{ url_for('chat.chat_reset') }}" class="btn btn-secondary">â™»ï¸ åˆæœŸåŒ–</a>
</div>

<!-- âœ… Claudeè©•ä¾¡å¾Œã®å‡ºåŠ›èª˜å°UI -->
{% if stage == "confirmed" and user_requirements %}
<hr>
<h4>ğŸ›  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š</h4>
<div class="btn-group" role="group">
  <a href="{{ url_for('preview.preview_structure', structure_id=user_requirements['id']) }}" class="btn btn-success">
    âœ… å‡ºåŠ›ã«é€²ã‚€
  </a>
  <a href="{{ url_for('structure.edit_structure', structure_id=user_requirements['id']) }}" class="btn btn-warning">
    âœï¸ ä¿®æ­£ã™ã‚‹
  </a>
  <form method="post" action="{{ url_for('chat.save_structure_route') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="chat_history_json" value='{{ user_requirements | tojson | safe }}'>
    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
  </form>
</div>
{% endif %}

<!-- âœ… æ§‹æˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º -->
{% if structure %}
<hr>
<h4>ğŸ§© ç”Ÿæˆã•ã‚ŒãŸæ§‹æˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
<pre style="background-color:#f8f9fa; padding:1em; border-radius:8px; overflow-x:auto;">
{{ structure | tojson(indent=2) }}
</pre>
{% endif %}

{% endblock %}
