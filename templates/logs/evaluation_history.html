<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©•ä¾¡å±¥æ­´ - {{ structure_id }}</title>
    <style>
        body { background: #1e1e1e; color: #ccc; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 40px auto; background: #252526; border-radius: 8px; padding: 32px; }
        h1 { color: #4ec9b0; margin-bottom: 8px; }
        .meta { color: #888; font-size: 14px; margin-bottom: 24px; }
        .back-link { color: #4ec9b0; text-decoration: none; font-size: 14px; margin-bottom: 24px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #3e3e42; }
        .nav-tab { background: none; border: none; color: #888; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .nav-tab.active { color: #4ec9b0; border-bottom-color: #4ec9b0; }
        .nav-tab:hover { color: #ccc; }
        .search-controls { background: #2d2d30; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .search-row { display: flex; gap: 15px; margin-bottom: 10px; align-items: center; }
        .search-input { flex: 1; background: #1e1e1e; border: 1px solid #3e3e42; color: #ccc; padding: 8px 12px; border-radius: 4px; }
        .search-input:focus { outline: none; border-color: #4ec9b0; }
        .sort-select { background: #1e1e1e; border: 1px solid #3e3e42; color: #ccc; padding: 8px 12px; border-radius: 4px; }
        .date-input { background: #1e1e1e; border: 1px solid #3e3e42; color: #ccc; padding: 8px 12px; border-radius: 4px; }
        .evaluation-list { margin: 0; padding: 0; list-style: none; }
        .evaluation-item { background: #2d2d30; border-radius: 6px; margin-bottom: 15px; padding: 20px; }
        .evaluation-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .evaluation-meta { flex: 1; }
        .evaluation-timestamp { color: #aaa; font-size: 13px; margin-bottom: 5px; }
        .evaluation-score { font-size: 18px; font-weight: bold; color: #4ec9b0; }
        .evaluation-feedback { color: #ccc; line-height: 1.5; margin-bottom: 15px; }
        .evaluation-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-apply { background: #4ec9b0; color: white; }
        .btn-apply:hover { background: #45b8a0; }
        .btn-detail { background: #2d2d30; color: #ccc; border: 1px solid #3e3e42; }
        .btn-detail:hover { background: #3e3e42; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #252526; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: #ccc; }
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state h3 { margin-bottom: 10px; color: #ccc; }
    </style>
</head>
<body>
<div class="container">
    <a href="/logs/structure/{{ structure_id }}" class="back-link">â† å±¥æ­´ä¸€è¦§ã«æˆ»ã‚‹</a>
    <h1>ğŸ§  è©•ä¾¡å±¥æ­´</h1>
    <div class="meta">
        <span>æ§‹æˆID: <b>{{ structure_id }}</b></span>
        {% if structure and structure.title %} | <span>ã‚¿ã‚¤ãƒˆãƒ«: <b>{{ structure.title }}</b></span>{% endif %}
    </div>
    
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
    <div class="nav-tabs">
        <a href="/logs/structure/{{ structure_id }}" class="nav-tab">ğŸ“Š å…¨ä½“å±¥æ­´</a>
        <a href="/logs/structure/{{ structure_id }}/evaluations" class="nav-tab active">ğŸ§  è©•ä¾¡å±¥æ­´</a>
        <a href="/logs/structure/{{ structure_id }}/completions" class="nav-tab">ğŸ” è£œå®Œå±¥æ­´</a>
    </div>
    
    <!-- æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="search-controls">
        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ¤œç´¢...">
            <select id="sortSelect" class="sort-select">
                <option value="timestamp-desc">æ—¥æ™‚ï¼ˆæ–°ã—ã„é †ï¼‰</option>
                <option value="timestamp-asc">æ—¥æ™‚ï¼ˆå¤ã„é †ï¼‰</option>
                <option value="score-desc">ã‚¹ã‚³ã‚¢ï¼ˆé«˜ã„é †ï¼‰</option>
                <option value="score-asc">ã‚¹ã‚³ã‚¢ï¼ˆä½ã„é †ï¼‰</option>
            </select>
        </div>
        <div class="search-row">
            <input type="date" id="dateFrom" class="date-input" placeholder="é–‹å§‹æ—¥">
            <span style="color: #888;">ã€œ</span>
            <input type="date" id="dateTo" class="date-input" placeholder="çµ‚äº†æ—¥">
            <button onclick="clearFilters()" class="btn btn-detail">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>
    
    {% if evaluations %}
    <ul class="evaluation-list" id="evaluationList">
        {% for eval in evaluations %}
        <li class="evaluation-item" 
            data-timestamp="{{ eval.timestamp }}" 
            data-score="{{ eval.score }}" 
            data-feedback="{{ eval.feedback }}"
            data-date="{{ eval.timestamp[:10] if eval.timestamp }}">
            <div class="evaluation-header">
                <div class="evaluation-meta">
                    <div class="evaluation-timestamp">{{ eval.timestamp[:19].replace('T', ' ') if eval.timestamp }}</div>
                    <div class="evaluation-score">ã‚¹ã‚³ã‚¢: {{ "%.1f"|format(eval.score * 100) if eval.score else "N/A" }}</div>
                </div>
                <div class="evaluation-actions">
                    <button class="btn btn-apply" onclick="applyEvaluation('{{ structure_id }}', '{{ eval.timestamp }}')">
                        âœ… å†é©ç”¨
                    </button>
                    <button class="btn btn-detail" onclick="showDetail({{ loop.index0 }})">
                        ğŸ” è©³ç´°
                    </button>
                </div>
            </div>
            <div class="evaluation-feedback">
                {{ eval.feedback[:60] + "..." if eval.feedback and eval.feedback|length > 60 else eval.feedback or "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãªã—" }}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state">
        <h3>ğŸ“­ è©•ä¾¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
        <p>ã“ã®æ§‹æˆã®è©•ä¾¡å±¥æ­´ã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        <p>çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€å±¥æ­´ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    {% endif %}
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <h3>ğŸ” è©•ä¾¡è©³ç´°</h3>
        <div id="modalContent"></div>
    </div>
</div>

<script>
// è©•ä¾¡ãƒ‡ãƒ¼ã‚¿
const evaluations = {{ evaluations | tojson | safe }};

// æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
function filterEvaluations() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const sortBy = document.getElementById('sortSelect').value;
    
    const items = document.querySelectorAll('.evaluation-item');
    
    items.forEach(item => {
        const feedback = item.dataset.feedback.toLowerCase();
        const date = item.dataset.date;
        
        let show = true;
        
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (searchTerm && !feedback.includes(searchTerm)) {
            show = false;
        }
        
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (dateFrom && date < dateFrom) {
            show = false;
        }
        if (dateTo && date > dateTo) {
            show = false;
        }
        
        item.style.display = show ? 'block' : 'none';
    });
    
    // ã‚½ãƒ¼ãƒˆ
    sortEvaluations(sortBy);
}

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
function sortEvaluations(sortBy) {
    const list = document.getElementById('evaluationList');
    const items = Array.from(list.children);
    
    items.sort((a, b) => {
        switch (sortBy) {
            case 'timestamp-desc':
                return new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp);
            case 'timestamp-asc':
                return new Date(a.dataset.timestamp) - new Date(b.dataset.timestamp);
            case 'score-desc':
                return parseFloat(b.dataset.score) - parseFloat(a.dataset.score);
            case 'score-asc':
                return parseFloat(a.dataset.score) - parseFloat(b.dataset.score);
            default:
                return 0;
        }
    });
    
    items.forEach(item => list.appendChild(item));
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('sortSelect').value = 'timestamp-desc';
    filterEvaluations();
}

// è©•ä¾¡å†é©ç”¨
function applyEvaluation(structureId, timestamp) {
    if (confirm('ã“ã®è©•ä¾¡ã‚’å†é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ')) {
        fetch(`/logs/apply/${structureId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ timestamp: timestamp })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/unified/${structureId}`;
            } else {
                alert('å†é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('å†é©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
            alert('å†é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }
}

// è©³ç´°è¡¨ç¤º
function showDetail(index) {
    const eval = evaluations[index];
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('modalContent');
    
    content.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>æ—¥æ™‚:</strong> ${eval.timestamp ? eval.timestamp.replace('T', ' ') : 'N/A'}
        </div>
        <div style="margin-bottom: 15px;">
            <strong>ã‚¹ã‚³ã‚¢:</strong> ${eval.score ? (eval.score * 100).toFixed(1) : 'N/A'}
        </div>
        <div style="margin-bottom: 15px;">
            <strong>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</strong><br>
            <div style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin-top: 5px; white-space: pre-wrap;">
                ${eval.feedback || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãªã—'}
            </div>
        </div>
        ${eval.details ? `
        <div style="margin-bottom: 15px;">
            <strong>è©³ç´°:</strong><br>
            <div style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin-top: 5px;">
                <pre>${JSON.stringify(eval.details, null, 2)}</pre>
            </div>
        </div>
        ` : ''}
    `;
    
    modal.style.display = 'block';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
function closeModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', filterEvaluations);
    document.getElementById('sortSelect').addEventListener('change', filterEvaluations);
    document.getElementById('dateFrom').addEventListener('change', filterEvaluations);
    document.getElementById('dateTo').addEventListener('change', filterEvaluations);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('detailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
});
</script>
</body>
</html> 