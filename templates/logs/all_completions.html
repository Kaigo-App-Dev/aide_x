<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è£œå®Œå±¥æ­´ä¸€è¦§</title>
    <style>
        body { background: #1e1e1e; color: #ccc; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1400px; margin: 40px auto; background: #252526; border-radius: 8px; padding: 32px; }
        h1 { color: #4ec9b0; margin-bottom: 8px; }
        .back-link { color: #4ec9b0; text-decoration: none; margin-bottom: 24px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        .stats { background: #2d2d30; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #4ec9b0; }
        .stat-label { color: #888; font-size: 12px; margin-top: 4px; }
        .filters { background: #2d2d30; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .filter-row { display: flex; gap: 16px; align-items: center; margin-bottom: 12px; }
        .filter-row:last-child { margin-bottom: 0; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { color: #ccc; font-size: 14px; min-width: 80px; }
        .filter-input { background: #1e1e1e; border: 1px solid #3c3c3c; color: #ccc; padding: 6px 12px; border-radius: 4px; }
        .filter-input:focus { outline: none; border-color: #4ec9b0; }
        .filter-button { background: #4ec9b0; color: #1e1e1e; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; }
        .filter-button:hover { background: #45b8a0; }
        .filter-button.active { background: #c586c0; }
        .search-box { flex: 1; }
        .search-input { width: 100%; background: #1e1e1e; border: 1px solid #3c3c3c; color: #ccc; padding: 8px 12px; border-radius: 4px; }
        .search-input:focus { outline: none; border-color: #4ec9b0; }
        .table-container { background: #1e1e1e; border-radius: 6px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2d2d30; color: #4ec9b0; padding: 12px; text-align: left; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #3c3c3c; }
        tr:hover { background: #2d2d30; }
        .title-link { color: #4ec9b0; text-decoration: none; }
        .title-link:hover { text-decoration: underline; }
        .count-badge { background: #4ec9b0; color: #1e1e1e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .count-badge:hover { background: #45b8a0; cursor: pointer; }
        .compare-link { color: #c586c0; text-decoration: none; font-size: 12px; }
        .compare-link:hover { text-decoration: underline; }
        .empty-message { text-align: center; color: #888; padding: 40px; font-style: italic; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <a href="/unified" class="back-link">â† çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</a>
    <h1>ğŸ“ è£œå®Œå±¥æ­´ä¸€è¦§</h1>
    
    <!-- çµ±è¨ˆæƒ…å ± -->
    <div class="stats">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">ç·ä»¶æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="structureCount">0</div>
                <div class="stat-label">æ§‹æˆæ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgTokens">0</div>
                <div class="stat-label">å¹³å‡ãƒˆãƒ¼ã‚¯ãƒ³æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="medianTokens">0</div>
                <div class="stat-label">ä¸­å¤®å€¤ãƒˆãƒ¼ã‚¯ãƒ³æ•°</div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="filters">
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label">è¡¨ç¤º:</span>
                <button class="filter-button active" data-filter="all">ã™ã¹ã¦</button>
                <button class="filter-button" data-filter="recent">æœ€è¿‘</button>
            </div>
            <div class="filter-group">
                <span class="filter-label">ä¸¦ã³é †:</span>
                <button class="filter-button active" data-sort="desc">æ–°ã—ã„é †</button>
                <button class="filter-button" data-sort="asc">å¤ã„é †</button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢..." id="searchInput">
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label">æ—¥ä»˜ç¯„å›²:</span>
                <input type="date" class="filter-input" id="fromDate">
                <span style="color: #888;">ã€œ</span>
                <input type="date" class="filter-input" id="toDate">
                <button class="filter-button" onclick="applyDateFilter()">é©ç”¨</button>
                <button class="filter-button" onclick="clearDateFilter()">ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-container">
        <table id="completionsTable">
            <thead>
                <tr>
                    <th>æ§‹æˆã‚¿ã‚¤ãƒˆãƒ«</th>
                    <th>è£œå®Œå†…å®¹</th>
                    <th>æ—¥æ™‚</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="completionsTableBody">
                {% for completion in completions %}
                <tr data-title="{{ completion.title.lower() }}" data-timestamp="{{ completion.timestamp }}" data-tokens="{{ completion.content|length if completion.content else 0 }}">
                    <td>
                        <a href="/unified/{{ completion.structure_id }}" class="title-link">
                            {{ completion.title or 'ç„¡é¡Œ' }}
                        </a>
                        <span class="count-badge" onclick="filterByStructure('{{ completion.structure_id }}')">1</span>
                    </td>
                    <td>
                        <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ completion.content or 'å†…å®¹ãªã—' }}
                        </div>
                    </td>
                    <td>{{ completion.timestamp }}</td>
                    <td>
                        <a href="/compare/{{ completion.structure_id }}/{{ completion.timestamp }}" class="compare-link">æ¯”è¼ƒ</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="emptyMessage" class="empty-message hidden">
            è£œå®Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
        </div>
    </div>
</div>

<script>
// ãƒ‡ãƒ¼ã‚¿
let allCompletions = {{ completions | tojson | safe }};
let filteredCompletions = [...allCompletions];
let currentSort = 'desc';
let currentFilter = 'all';

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    updateTable();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('searchInput').addEventListener('input', filterByTitle);
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            applyFilters();
        });
    });
    
    // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³
    document.querySelectorAll('[data-sort]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-sort]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSort = this.dataset.sort;
            applyFilters();
        });
    });
});

// çµ±è¨ˆæ›´æ–°
function updateStats() {
    const totalCount = filteredCompletions.length;
    const structureIds = new Set(filteredCompletions.map(c => c.structure_id));
    const structureCount = structureIds.size;
    
    // ãƒˆãƒ¼ã‚¯ãƒ³æ•°è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šæ–‡å­—æ•°ï¼‰
    const tokenCounts = filteredCompletions.map(c => c.content ? c.content.length : 0);
    const avgTokens = tokenCounts.length > 0 ? Math.round(tokenCounts.reduce((a, b) => a + b, 0) / tokenCounts.length) : 0;
    const medianTokens = tokenCounts.length > 0 ? calculateMedian(tokenCounts) : 0;
    
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('structureCount').textContent = structureCount;
    document.getElementById('avgTokens').textContent = avgTokens;
    document.getElementById('medianTokens').textContent = medianTokens;
}

// ä¸­å¤®å€¤è¨ˆç®—
function calculateMedian(arr) {
    const sorted = arr.slice().sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 === 0 ? Math.round((sorted[mid - 1] + sorted[mid]) / 2) : sorted[mid];
}

// ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ã‚£ãƒ«ã‚¿
function filterByTitle() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    filteredCompletions = allCompletions.filter(c => 
        c.title && c.title.toLowerCase().includes(searchTerm)
    );
    applyFilters();
}

// æ§‹æˆIDãƒ•ã‚£ãƒ«ã‚¿
function filterByStructure(structureId) {
    filteredCompletions = allCompletions.filter(c => c.structure_id === structureId);
    applyFilters();
}

// æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
function applyDateFilter() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    filteredCompletions = allCompletions.filter(c => {
        const timestamp = c.timestamp;
        if (fromDate && timestamp < fromDate) return false;
        if (toDate && timestamp > toDate) return false;
        return true;
    });
    applyFilters();
}

// æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
function clearDateFilter() {
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    filteredCompletions = [...allCompletions];
    applyFilters();
}

// ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
function applyFilters() {
    // è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿
    if (currentFilter === 'recent') {
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        filteredCompletions = filteredCompletions.filter(c => new Date(c.timestamp) > oneWeekAgo);
    }
    
    // ã‚½ãƒ¼ãƒˆ
    filteredCompletions.sort((a, b) => {
        const comparison = a.timestamp.localeCompare(b.timestamp);
        return currentSort === 'desc' ? -comparison : comparison;
    });
    
    updateStats();
    updateTable();
}

// ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
function updateTable() {
    const tbody = document.getElementById('completionsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (filteredCompletions.length === 0) {
        tbody.innerHTML = '';
        emptyMessage.classList.remove('hidden');
        return;
    }
    
    emptyMessage.classList.add('hidden');
    
    tbody.innerHTML = filteredCompletions.map(completion => `
        <tr data-title="${completion.title ? completion.title.toLowerCase() : ''}" data-timestamp="${completion.timestamp}" data-tokens="${completion.content ? completion.content.length : 0}">
            <td>
                <a href="/unified/${completion.structure_id}" class="title-link">
                    ${completion.title || 'ç„¡é¡Œ'}
                </a>
                <span class="count-badge" onclick="filterByStructure('${completion.structure_id}')">1</span>
            </td>
            <td>
                <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${completion.content || 'å†…å®¹ãªã—'}
                </div>
            </td>
            <td>${completion.timestamp}</td>
            <td>
                <a href="/compare/${completion.structure_id}/${completion.timestamp}" class="compare-link">æ¯”è¼ƒ</a>
            </td>
        </tr>
    `).join('');
}
</script>
</body>
</html> 