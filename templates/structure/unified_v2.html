{% extends "base_layout.html" %}

{% block title %}AIDE-X çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ v2 - {{ structure_id }}{% endblock %}

{% block head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- æ–°UIç”¨ã®CSSãƒ•ã‚¡ã‚¤ãƒ« -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/unified_v2.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/structure.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/completion.css') }}?v={{ timestamp }}">
{% endblock %}

{% block content %}
<div class="unified-v2-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="unified-v2-header">
        <div class="header-title">
            <h1>ğŸ¤– AIDE-X çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ v2</h1>
            <span class="structure-id">ID: {{ structure_id }}</span>
        </div>
        <div class="header-controls">
            <button id="expand-all-panes" class="btn btn-primary" title="å…¨ãƒšã‚¤ãƒ³å±•é–‹ (Ctrl+0)">
                ğŸ“‹ å…¨å±•é–‹
            </button>
            <button id="reset-layout" class="btn btn-secondary" title="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒªã‚»ãƒƒãƒˆ">
                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="unified-v2-main">
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆ -->
        <div class="unified-v2-pane" id="chat-pane" data-pane="chat">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
                </div>
                <div class="pane-actions">
                    <button class="pane-toggle" data-pane="chat" title="ãƒãƒ£ãƒƒãƒˆãƒšã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ (Ctrl+1)">
                        â—€
                    </button>
                </div>
            </div>
            <div class="pane-content">
                {% if messages is not none %}
                    {% set msg_list_safe = messages %}
                {% else %}
                    {% set msg_list_safe = [] %}
                {% endif %}
                
                <!-- ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/chat_panel.html' %}
            </div>
        </div>

        <!-- å·¦ãƒšã‚¤ãƒ³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
        <div class="pane-resizer" data-resize="chat-pane"></div>

        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ï¼šæ§‹æˆ -->
        <div class="unified-v2-pane" id="structure-pane" data-pane="structure">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ“‹ æ§‹æˆ
                </div>
                <div class="pane-actions">
                    <button class="pane-toggle" data-pane="structure" title="æ§‹æˆãƒšã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ (Ctrl+2)">
                        â—€â–¶
                    </button>
                </div>
            </div>
            <div class="pane-content">
                <!-- æ§‹é€ ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/structure_panel.html' %}
            </div>
        </div>

        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
        <div class="pane-resizer" data-resize="structure-pane"></div>

        <!-- å³ãƒšã‚¤ãƒ³ï¼šGeminiè£œå®Œ -->
        <div class="unified-v2-pane" id="gemini-pane" data-pane="gemini">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ¤– Geminiè£œå®Œ
                </div>
                <div class="pane-actions">
                    <button class="pane-toggle" data-pane="gemini" title="Geminiãƒšã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ (Ctrl+3)">
                        â–¶
                    </button>
                </div>
            </div>
            <div class="pane-content">
                <!-- Geminiè£œå®Œãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/completion_panel.html' %}
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <div class="unified-v2-statusbar">
        <div class="status-left">
            <span class="status-indicator" id="connection-status">ğŸŸ¢ æ¥ç¶šä¸­</span>
            <span class="status-text" id="current-status">åˆæœŸåŒ–å®Œäº†</span>
        </div>
        <div class="status-right">
            <span class="version-info">v2.0.0</span>
        </div>
    </div>
</div>

<!-- æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦åŸ‹ã‚è¾¼ã¿ -->
<script id="structure-data" type="application/json">
{% if structure_data and structure_data.content %}
{{ structure_data | tojson }}
{% elif request.args.get('debug') == 'true' or request.args.get('test_mode') == 'true' %}
{
  "id": "test-structure-v2",
  "content": {
    "sections": [
      {
        "title": "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
        "description": "v2ç”¨ã®ãƒ†ã‚¹ãƒˆæ§‹æˆã§ã™ã€‚",
        "components": [
          {
            "type": "text",
            "content": "ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚"
          }
        ]
      }
    ]
  },
  "gemini_output": {
    "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³": {
      "title": "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
      "output": "ã“ã‚Œã¯Geminiã®v2ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ã™ã€‚"
    }
  },
  "created_at": "{{ timestamp }}",
  "status": "test",
  "test_mode": true
}
{% else %}
null
{% endif %}
</script>
{% endblock %}

{% block scripts %}
<!-- æ–°UIç”¨ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="{{ url_for('static', filename='js/layout_manager_v2.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/gemini_parser_v2.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/unified_v2_app.js') }}?v={{ timestamp }}"></script>

<!-- æ—¢å­˜ã®JSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰ -->
<script src="{{ url_for('static', filename='js/utils.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/chat_handler.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/claude_renderer.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/structure_cards.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/diff_renderer.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/history_handler.js') }}?v={{ timestamp }}"></script>

<script>
// æ–°UIåˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Unified v2 åˆæœŸåŒ–é–‹å§‹');
    
    // æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
    const structureDataElement = document.getElementById('structure-data');
    if (structureDataElement) {
        try {
            window.structureData = JSON.parse(structureDataElement.textContent);
            console.log('âœ… æ§‹é€ ãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº†:', {
                id: window.structureData?.id,
                hasContent: !!(window.structureData && window.structureData.content),
                hasGeminiOutput: !!(window.structureData && window.structureData.gemini_output)
            });
        } catch (error) {
            console.error('âŒ æ§‹é€ ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error);
            window.structureData = null;
        }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
    window.isDebugMode = {{ 'true' if request.args.get('debug') == 'true' else 'false' }};
    window.isTestMode = {{ 'true' if request.args.get('test_mode') == 'true' else 'false' }};
    
    // æ–°UIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    if (typeof UnifiedV2App !== 'undefined') {
        console.log('âœ… UnifiedV2Appã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–');
        window.unifiedV2App = new UnifiedV2App();
        window.unifiedV2App.init();
    } else {
        console.error('âŒ UnifiedV2AppãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    console.log('âœ… Unified v2 åˆæœŸåŒ–å®Œäº†');
});
</script>
{% endblock %} 