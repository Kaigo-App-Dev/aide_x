{% extends "base_layout.html" %}

{% block title %}AIDE-X çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ - {{ structure_id }}{% endblock %}

{% block head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="main-container">
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆ -->
        <div class="chat-pane">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
                </div>
                <div class="pane-actions">
                    <button class="pane-toggle" onclick="toggleChatPane()">â—€</button>
                </div>
            </div>
            <div class="pane-content">
                {% if messages is not none %}
                  {% set msg_list_safe = messages %}
                {% else %}
                  {% set msg_list_safe = [] %}
                {% endif %}
                
                <!-- ãƒãƒ£ãƒƒãƒˆå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’include -->
                {% include 'structure/chat.html' %}
            </div>
        </div>
        
        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ï¼šæ§‹æˆ -->
        <div class="center-pane">
            <!-- æ§‹æˆå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’include -->
            {% include 'structure/structure.html' %}
        </div>
        
        <!-- å³ãƒšã‚¤ãƒ³ï¼šè£œåŠ©UI -->
        <div class="right-pane">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ› ï¸ è£œåŠ©ãƒ„ãƒ¼ãƒ«
                </div>
                <div class="pane-actions">
                    <button class="pane-toggle" onclick="toggleRightPane()">â–¶</button>
                </div>
            </div>
            <div class="pane-content">
                <!-- è£œåŠ©UIå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’include -->
                {% include 'structure/structure_ui.html' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/unified.js') }}?v=1.0.4"></script>
<script>
// ãƒšã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function toggleChatPane() {
    const chatPane = document.querySelector('.chat-pane');
    chatPane.classList.toggle('collapsed');
}

function toggleRightPane() {
    const rightPane = document.querySelector('.right-pane');
    rightPane.classList.toggle('collapsed');
}

function toggleOutputPane() {
    const outputPane = document.getElementById('output-pane');
    const toggleBtn = document.getElementById('output-toggle-icon');
    
    if (outputPane.classList.contains('visible')) {
        outputPane.classList.remove('visible');
        toggleBtn.textContent = 'â–¼';
    } else {
        outputPane.classList.add('visible');
        toggleBtn.textContent = 'â—€';
    }
}

// ã‚«ãƒ¼ãƒ‰å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
function toggleCard(header) {
    const card = header.closest('.structure-card');
    card.classList.toggle('expanded');
}

function renderDiffHighlight(currentData, previousData) {
  if (!currentData || !previousData) return;
  const ignoreKeys = ['evaluations', 'completions', 'timestamp'];
  const allKeys = Array.from(new Set([...Object.keys(currentData), ...Object.keys(previousData)]));
  let prevHtml = '';
  let currHtml = '';
  allKeys.forEach(key => {
    if (ignoreKeys.includes(key)) return;
    const prevVal = previousData[key];
    const currVal = currentData[key];
    let prevClass = 'unchanged', currClass = 'unchanged';
    if (prevVal !== currVal) {
      prevClass = 'changed';
      currClass = 'changed';
    }
    prevHtml += `<div class="diff-line ${prevClass}"><strong>${key}:</strong> ${prevVal ?? '-'}</div>`;
    currHtml += `<div class="diff-line ${currClass}"><strong>${key}:</strong> ${currVal ?? '-'}</div>`;
  });
  document.getElementById('previousContent').innerHTML = prevHtml || '<div class="no-diff">æ§‹æˆæƒ…å ±ãªã—</div>';
  document.getElementById('currentContent').innerHTML = currHtml || '<div class="no-diff">æ§‹æˆæƒ…å ±ãªã—</div>';
}

window.addEventListener('DOMContentLoaded', function() {
  // ãƒšã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆæœŸåŒ–ï¼ˆunifiedInterfaceãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œï¼‰
  setTimeout(function() {
    if (window.unifiedInterface) {
      window.unifiedInterface.initializePaneLayout();
    } else {
      console.warn('âš ï¸ unifiedInterfaceãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }, 100);
});
</script>
{% endblock %} 