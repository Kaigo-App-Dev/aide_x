{% extends "base_layout.html" %}

{% block title %}AIDE-X çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ - {{ structure_id }}{% endblock %}

{% block head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- åˆ†å‰²ã•ã‚ŒãŸCSSãƒ•ã‚¡ã‚¤ãƒ« -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/structure.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/completion.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pane_toggle.css') }}?v={{ timestamp }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="main-container">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å®Œå…¨ã«éè¡¨ç¤ºã« -->
        <div id="loading-overlay" style="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -9999 !important; pointer-events: none !important;"></div>
        
        <!-- å·¦ãƒšã‚¤ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆ -->
        <div class="chat-pane" id="chat-pane" style="display: flex; visibility: visible; opacity: 1; pointer-events: auto;">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
                </div>
                <div class="pane-actions">
                    <button 
                        class="pane-toggle" 
                        title="Chatãƒšã‚¤ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹ (Ctrl+1)"
                        aria-expanded="true"
                        aria-controls="chat-pane"
                        aria-label="ãƒãƒ£ãƒƒãƒˆãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                        <span class="sr-only">ãƒãƒ£ãƒƒãƒˆãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€</span>
                        â—€
                    </button>
                </div>
            </div>
            <div class="pane-content">
                {% if messages is not none %}
                  {% set msg_list_safe = messages %}
                {% else %}
                  {% set msg_list_safe = [] %}
                {% endif %}
                
                <!-- ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/chat_panel.html' %}
            </div>
        </div>
        
        <!-- å·¦ãƒšã‚¤ãƒ³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
        <div class="pane-resizer left-resizer" data-resize="chat-pane"></div>
        
        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ï¼šæ§‹æˆ -->
        <div class="center-pane" id="center-pane" style="display: flex; visibility: visible; opacity: 1; pointer-events: auto;">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ“‹ æ§‹æˆ
                </div>
                <div class="pane-actions">
                    <button 
                        class="pane-toggle" 
                        title="ä¸­å¤®ãƒšã‚¤ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹ (Ctrl+2)"
                        aria-expanded="true"
                        aria-controls="center-pane"
                        aria-label="ä¸­å¤®ãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                        <span class="sr-only">ä¸­å¤®ãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€</span>
                        â—€â–¶
                    </button>
                </div>
            </div>
            <div class="pane-content">
                <!-- æ§‹é€ ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/structure_panel.html' %}
            </div>
        </div>
        
        <!-- ä¸­å¤®ãƒšã‚¤ãƒ³ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
        <div class="pane-resizer center-resizer" data-resize="center-pane"></div>
        
        <!-- å³ãƒšã‚¤ãƒ³ï¼šGeminiè£œå®Œ -->
        <div class="gemini-pane" id="gemini-pane" style="display: flex; visibility: visible; opacity: 1; pointer-events: auto;">
            <div class="pane-header">
                <div class="pane-title">
                    ğŸ¤– Geminiè£œå®Œ
                </div>
                <div class="pane-actions">
                    <button 
                        class="pane-toggle" 
                        title="Geminiãƒšã‚¤ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹ (Ctrl+3)"
                        aria-expanded="true"
                        aria-controls="gemini-pane"
                        aria-label="Geminiãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€">
                        <span class="sr-only">Geminiãƒšã‚¤ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€</span>
                        â–¶
                    </button>
                </div>
            </div>
            <div class="pane-content">
                <!-- Geminiè£œå®Œãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
                {% include 'components/completion_panel.html' %}
            </div>
        </div>
    </div>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆUI -->
<div id="debug-mode-toggle" style="position: fixed; top: 10px; left: 10px; z-index: 9999; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; font-family: monospace;">
    <div style="margin-bottom: 5px;">
        <strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡</strong>
    </div>
    <div style="margin-bottom: 5px;">
        <label>
            <input type="checkbox" id="debug-mode-checkbox" style="margin-right: 5px;">
            ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
        </label>
    </div>
    <div style="margin-bottom: 5px;">
        <button id="toggle-debug-mode" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
            ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        </button>
        <button id="reload-page" style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 5px;">
            å†èª­ã¿è¾¼ã¿
        </button>
    </div>
    <div style="font-size: 10px; opacity: 0.8;">
        ç¾åœ¨: <span id="current-mode">ç¢ºèªä¸­...</span>
    </div>
</div>

<!-- æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦åŸ‹ã‚è¾¼ã¿ -->
<script id="structure-data" type="application/json">
{% if structure_data and structure_data.content %}
{{ structure_data | tojson }}
{% elif request.args.get('debug') == 'true' or request.args.get('test_mode') == 'true' %}
{
  "id": "test-structure-001",
  "content": {
    "sections": [
      {
        "title": "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
        "description": "ã“ã‚Œã¯æ§‹æˆã®è¡¨ç¤ºã¨è©•ä¾¡ç”¨ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
        "components": [
          {
            "type": "text",
            "content": "ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚"
          }
        ]
      }
    ]
  },
  "gemini_output": {
    "æµ‹è¯•ã‚»ã‚¯ã‚·ãƒ§ãƒ³": {
      "title": "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
      "output": "ã“ã‚Œã¯Geminiã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ã™ã€‚"
    }
  },
  "created_at": "{{ timestamp }}",
  "status": "test",
  "test_mode": true
}
{% else %}
null
{% endif %}
</script>
{% endblock %}

{% block scripts %}
<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åºã‚’æœ€é©åŒ– -->
<!-- 1. gemini_parser.js -->
<script src="{{ url_for('static', filename='js/gemini_parser.js') }}?v={{ timestamp }}"></script>

<!-- 2. layout_manager.js -->
<script src="{{ url_for('static', filename='js/layout_manager.js') }}?v={{ timestamp }}"></script>

<!-- 3. ãã®ä»–ã®JSãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="{{ url_for('static', filename='js/utils.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/chat_handler.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/claude_renderer.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/structure_cards.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/diff_renderer.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/history_handler.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/module_diff.js') }}?v={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/renderer.js') }}?v={{ timestamp }}"></script>

<script>
// JSãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª
console.log('ğŸ“¦ JSãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª:', {
    GeminiParserExists: typeof GeminiParser !== 'undefined',
    LayoutManagerExists: typeof LayoutManager !== 'undefined',
    AppInitializerExists: typeof AppInitializer !== 'undefined',
    UtilsExists: typeof Utils !== 'undefined',
    ChatHandlerExists: typeof ChatHandler !== 'undefined',
    ClaudeRendererExists: typeof ClaudeRenderer !== 'undefined',
    StructureCardsExists: typeof StructureCards !== 'undefined',
    DiffRendererExists: typeof DiffRenderer !== 'undefined',
    HistoryHandlerExists: typeof HistoryHandler !== 'undefined',
    ModuleDiffExists: typeof ModuleDiff !== 'undefined',
    RendererExists: typeof Renderer !== 'undefined'
});

// GeminiParserèª­ã¿è¾¼ã¿ç¢ºèªï¼ˆé‡è¦ï¼‰
if (typeof GeminiParser !== 'undefined') {
    console.log('âœ… GeminiParserã‚¯ãƒ©ã‚¹ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™');
    console.log('ğŸ§ª GeminiParserè©³ç´°:', {
        constructor: GeminiParser.constructor.name,
        prototype: !!GeminiParser.prototype,
        hasInit: typeof GeminiParser.prototype.init === 'function',
        hasUpdateGeminiOutput: typeof GeminiParser.prototype.updateGeminiOutput === 'function'
    });
} else {
    console.error('âŒ GeminiParserã‚¯ãƒ©ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
window.isDebugMode = {{ 'true' if request.args.get('debug') == 'true' else 'false' }};
window.isTestMode = {{ 'true' if request.args.get('test_mode') == 'true' else 'false' }};

console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹:', {
    isDebugMode: window.isDebugMode,
    isTestMode: window.isTestMode,
    debugParam: '{{ request.args.get("debug") }}',
    testModeParam: '{{ request.args.get("test_mode") }}'
});

// æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
const structureDataElement = document.getElementById('structure-data');
if (structureDataElement) {
    try {
        window.structureData = JSON.parse(structureDataElement.textContent);
        console.log('âœ… æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šå®Œäº†:', {
            id: window.structureData?.id,
            hasContent: !!(window.structureData && window.structureData.content),
            hasGeminiOutput: !!(window.structureData && window.structureData.gemini_output),
            sections: window.structureData?.content?.sections?.length || 0
        });
    } catch (error) {
        console.error('âŒ æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        window.structureData = null;
    }
} else {
    console.warn('âš ï¸ æ§‹é€ ãƒ‡ãƒ¼ã‚¿è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    window.structureData = null;
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ä»®ãƒ‡ãƒ¼ã‚¿æ³¨å…¥
if (window.isDebugMode || window.isTestMode) {
    console.log('ğŸ§ª ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ä»®ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥');
    
    if (!window.structureData) {
        window.structureData = {
            id: 'debug-structure',
            content: {
                sections: [
                    {
                        title: "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
                        description: "ã“ã‚Œã¯æ§‹æˆã®è¡¨ç¤ºã¨è©•ä¾¡ç”¨ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
                        components: [
                            {
                                type: "text",
                                content: "ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚"
                            }
                        ]
                    }
                ]
            },
            gemini_output: {
                "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³": {
                    title: "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
                    output: "ã“ã‚Œã¯Geminiã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ã™ã€‚"
                }
            },
            created_at: new Date().toISOString(),
            status: "test",
            test_mode: true
        };
    }
    
    // gemini_outputãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
    if (!window.structureData.gemini_output) {
        window.structureData.gemini_output = {
            "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³": {
                title: "ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³",
                output: "ã“ã‚Œã¯Geminiã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ã™ã€‚"
            }
        };
        console.log('âœ… ãƒ‡ãƒãƒƒã‚°ç”¨gemini_outputã‚’è¿½åŠ ');
    }
    
    console.log('ğŸ§ª ãƒ‡ãƒãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
        structureData: window.structureData,
        geminiOutput: window.structureData?.gemini_output
    });
}

// åˆæœŸåŒ–å®Œäº†å¾Œã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOMContentLoaded: åˆæœŸåŒ–é–‹å§‹');
    
    // å³åº§ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
    const loadingOverlays = document.querySelectorAll('#loading-overlay, .loading-overlay, .aide-loading, .screen-mask, .overlay');
    loadingOverlays.forEach(overlay => {
        overlay.style.display = 'none';
        overlay.style.visibility = 'hidden';
        overlay.style.opacity = '0';
        overlay.style.zIndex = '-9999';
        overlay.style.pointerEvents = 'none';
    });
    
    // å³åº§ã«ãƒšã‚¤ãƒ³ã‚’è¡¨ç¤º
    const panes = document.querySelectorAll('#chat-pane, #center-pane, #gemini-pane');
    panes.forEach(pane => {
        pane.style.display = 'flex';
        pane.style.visibility = 'visible';
        pane.style.opacity = '1';
        pane.style.pointerEvents = 'auto';
        pane.style.position = 'relative';
        pane.style.zIndex = '1';
        pane.classList.remove('hidden', 'collapsed');
    });
    
    // AppInitializerãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯åˆæœŸåŒ–
    if (typeof AppInitializer !== 'undefined') {
        console.log('âœ… AppInitializerã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–');
        const appInitializer = new AppInitializer();
        appInitializer.init();
    } else {
        console.warn('âš ï¸ AppInitializerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - æ‰‹å‹•åˆæœŸåŒ–');
        
        // æ‰‹å‹•åˆæœŸåŒ–
        if (typeof LayoutManager !== 'undefined') {
            console.log('âœ… LayoutManagerã‚’æ‰‹å‹•åˆæœŸåŒ–');
            window.layoutManager = new LayoutManager();
        }
        
        if (typeof GeminiParser !== 'undefined') {
            console.log('âœ… GeminiParserã‚’æ‰‹å‹•åˆæœŸåŒ–');
            window.geminiParser = new GeminiParser();
        }
    }
    
    // æœ€çµ‚ç¢ºèªï¼ˆé…å»¶å®Ÿè¡Œï¼‰
    setTimeout(() => {
        console.log('ğŸ” æœ€çµ‚UIçŠ¶æ…‹ç¢ºèª');
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®æœ€çµ‚ç¢ºèª
        const finalLoadingOverlays = document.querySelectorAll('#loading-overlay, .loading-overlay, .aide-loading, .screen-mask, .overlay');
        finalLoadingOverlays.forEach(overlay => {
            if (overlay.style.display !== 'none') {
                console.log('âš ï¸ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™:', overlay);
                overlay.style.display = 'none';
                overlay.style.visibility = 'hidden';
                overlay.style.opacity = '0';
                overlay.style.zIndex = '-9999';
                overlay.style.pointerEvents = 'none';
            }
        });
        
        // ãƒšã‚¤ãƒ³ã®æœ€çµ‚ç¢ºèª
        const finalPanes = document.querySelectorAll('#chat-pane, #center-pane, #gemini-pane');
        finalPanes.forEach(pane => {
            if (pane.style.display !== 'flex') {
                console.log('âš ï¸ ãƒšã‚¤ãƒ³ãŒã¾ã éè¡¨ç¤ºã§ã™:', pane.id);
                pane.style.display = 'flex';
                pane.style.visibility = 'visible';
                pane.style.opacity = '1';
                pane.style.pointerEvents = 'auto';
                pane.style.position = 'relative';
                pane.style.zIndex = '1';
                pane.classList.remove('hidden', 'collapsed');
            }
        });
        
        console.log('âœ… æœ€çµ‚UIçŠ¶æ…‹ç¢ºèªå®Œäº†');
    }, 200);
    
    console.log('âœ… åˆæœŸåŒ–å®Œäº†');
});
</script>
{% endblock %} 