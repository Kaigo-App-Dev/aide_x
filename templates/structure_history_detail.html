{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>ğŸ“ æ§‹æˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè©³ç´°: {{ structure.title or structure.id }}</h2>

  <!-- JSONè¡¨ç¤º -->
  <pre class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 600px; overflow-y: auto;">
{{ content_json }}
  </pre>

  <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="mt-5">
    <h3>ğŸ“ˆ è©•ä¾¡ã‚¹ã‚³ã‚¢æ¨ç§»</h3>
    <canvas id="scoreChart" width="800" height="400"></canvas>
    <p class="mt-3 small text-muted">
      æ„å›³ä¸€è‡´ç‡ã¨å“è³ªã‚¹ã‚³ã‚¢ã¯100%ã«è¿‘ã„ã»ã©è‰¯å¥½ã§ã™ã€‚<br>
      â¬† 80%ä»¥ä¸Šï¼šå®‰å®šæ§‹æˆã€50ã€œ80%ï¼šæ”¹å–„æ¤œè¨ã€50%æœªæº€ï¼šæ”¹å–„æ¨å¥¨ã€‚
    </p>
  </div>

  <div class="mt-4">
    <a href="{{ url_for('structure.history') }}" class="btn btn-secondary">â† å±¥æ­´ä¸€è¦§ã«æˆ»ã‚‹</a>
    <a href="{{ url_for('preview.preview_structure', structure_id=structure.id) }}"
       class="btn btn-info ms-2"
       onclick="return confirm('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æœ€å¾Œã«ä¿å­˜ã—ãŸçŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æœªä¿å­˜ã®å†…å®¹ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ');">
       ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Chart.js èª­ã¿è¾¼ã¿ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const structureId = "{{ structure.id }}";

    fetch(`/structure/score_history/${structureId}`)
      .then(response => response.json())
      .then(data => {
        const labels = data.map(entry => new Date(entry.timestamp).toLocaleString());
        const intentMatch = data.map(entry => entry.intent_match);
        const qualityScore = data.map(entry => entry.quality_score);

        const ctx = document.getElementById('scoreChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'æ„å›³ä¸€è‡´ç‡ï¼ˆIntent Matchï¼‰',
                data: intentMatch,
                borderColor: 'blue',
                tension: 0.3,
                fill: false
              },
              {
                label: 'å“è³ªã‚¹ã‚³ã‚¢ï¼ˆQuality Scoreï¼‰',
                data: qualityScore,
                borderColor: 'green',
                tension: 0.3,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                min: 0,
                max: 1.0,
                ticks: {
                  callback: function(value) {
                    return (value * 100).toFixed(1) + '%';
                  }
                },
                title: {
                  display: true,
                  text: 'ã‚¹ã‚³ã‚¢ï¼ˆ%ï¼‰'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'æ›´æ–°æ—¥æ™‚'
                }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = (context.raw * 100).toFixed(1);
                    return `${label}: ${value}%`;
                  }
                }
              },
              title: {
                display: true,
                text: 'æ§‹æˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é€²åŒ–ã‚¹ã‚³ã‚¢æ¨ç§»'
              }
            }
          }
        });
      });
  </script>
{% endblock %}
