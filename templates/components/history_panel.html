<!-- å±¥æ­´ãƒ‘ãƒãƒ« -->
<div class="aide-history-panel">
    <div class="aide-history-header">
        <h4>ğŸ“‹ å±¥æ­´</h4>
        <div class="aide-history-filters">
            <input type="text" id="historySearch" placeholder="æ¤œç´¢..." class="aide-form-control-sm">
            <select id="historyFilter" class="aide-form-control-sm">
                <option value="">ã™ã¹ã¦</option>
                <option value="save">ä¿å­˜</option>
                <option value="evaluation">è©•ä¾¡</option>
                <option value="chat">ä¼šè©±</option>
            </select>
        </div>
    </div>
    
    <div class="aide-history-list" id="historyList">
        {% if structure.get('history') %}
            {% for log in structure.history[-10:] %}
            <div class="aide-history-item" data-type="{{ log.action }}">
                <div class="aide-history-time">{{ log.timestamp }}</div>
                <div class="aide-history-action">{{ log.action }}</div>
                <div class="aide-history-detail">{{ log.detail[:50] }}{% if log.detail|length > 50 %}...{% endif %}</div>
            </div>
            {% endfor %}
        {% else %}
            <div class="aide-history-empty">
                <p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        {% endif %}
    </div>
    
    <div class="aide-history-actions">
        <button class="aide-btn aide-btn-outline-secondary aide-btn-sm" id="refreshHistoryBtn">
            ğŸ”„ æ›´æ–°
        </button>
        <button class="aide-btn aide-btn-outline-primary aide-btn-sm" id="exportHistoryBtn">
            ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
    </div>
</div>

<script>
// å±¥æ­´ãƒ‘ãƒãƒ«ç”¨ã®JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const structureId = '{{ structure.id }}';
    const historySearch = document.getElementById('historySearch');
    const historyFilter = document.getElementById('historyFilter');
    const historyList = document.getElementById('historyList');
    const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
    const exportHistoryBtn = document.getElementById('exportHistoryBtn');
    
    function filterHistory() {
        const searchTerm = historySearch.value.toLowerCase();
        const filterType = historyFilter.value;
        const historyItems = historyList.querySelectorAll('.aide-history-item');
        
        historyItems.forEach(item => {
            const action = item.querySelector('.aide-history-action').textContent.toLowerCase();
            const detail = item.querySelector('.aide-history-detail').textContent.toLowerCase();
            const type = item.dataset.type;
            
            const matchesSearch = action.includes(searchTerm) || detail.includes(searchTerm);
            const matchesFilter = !filterType || type === filterType;
            
            item.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
        });
    }
    
    function refreshHistory() {
        fetch(`/unified/${structureId}/history`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å±¥æ­´ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    historyList.innerHTML = data.history.map(log => `
                        <div class="aide-history-item" data-type="${log.action}">
                            <div class="aide-history-time">${log.timestamp}</div>
                            <div class="aide-history-action">${log.action}</div>
                            <div class="aide-history-detail">${log.detail.substring(0, 50)}${log.detail.length > 50 ? '...' : ''}</div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('å±¥æ­´æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            });
    }
    
    function exportHistory() {
        fetch(`/unified/${structureId}/export-history`)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `history_${structureId}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('å±¥æ­´ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    historySearch.addEventListener('input', filterHistory);
    historyFilter.addEventListener('change', filterHistory);
    refreshHistoryBtn.addEventListener('click', refreshHistory);
    exportHistoryBtn.addEventListener('click', exportHistory);
});
</script> 